<!DOCTYPE html>
<html>
<head>
    <title>Argus</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet" />
    <!-- Mapbox Draw -->
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.3.0/mapbox-gl-draw.css" type="text/css" />
    <style>
        body, html { height: 100%; margin: 0; padding: 0; }
        #map { height: 100%; }
        .sidebar {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 350px;
            background-color: white;
            overflow-y: auto;
            padding: 20px;
            z-index: 1000;
        }
        #map-container { position: absolute; top: 0; left: 350px; right: 0; bottom: 300px; /* Make space for bottom panel */ }
        #bottom-panel {
            position: absolute;
            bottom: 0;
            left: 350px;
            right: 0;
            height: 300px; /* Height of the panel */
            background-color: #fff;
            border-top: 1px solid #ddd;
            z-index: 1001;
            padding: 15px;
            overflow-y: hidden;
        }
        #bottom-panel.collapsed {
            height: 0;
            padding: 0;
            border-top: none;
        }
        #bottom-panel.collapsed #bottom-panel-content {
            display: none;
        }
        #panel-toggle-btn {
            position: absolute;
            bottom: 0; /* Position it at the bottom of its container (#map-container) */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
            border-radius: 5px 5px 0 0; /* Rounded top corners */
            padding: 2px 12px; /* Make it flatter */
            line-height: 1.2;
            border-bottom: none;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h1 class="h4">Route Comparison</h1>
    <hr>

    <div class="mb-3">
        <label for="country-select" class="form-label">Select Area</label>
        <select id="country-select" class="form-select">
            <option value="stuttgart">Germany (Stuttgart)</option>
            <option value="dubai">UAE (Dubai)</option>
            <option value="bangkok">Thailand (Bangkok)</option>
        </select>
    </div>

    <div class="btn-group w-100 mb-2" role="group">
        <input type="radio" class="btn-check" name="mode-select" id="mode-random" autocomplete="off" checked>
        <label class="btn btn-sm btn-outline-primary" for="mode-random">Random Compare</label>

        <input type="radio" class="btn-check" name="mode-select" id="mode-manual" autocomplete="off">
        <label class="btn btn-sm btn-outline-primary" for="mode-manual">Manual Selection</label>

        <input type="radio" class="btn-check" name="mode-select" id="mode-places" autocomplete="off">
        <label class="btn btn-sm btn-outline-primary" for="mode-places">Points From Google</label>
    </div>

    <div class="mb-3">
        <label class="form-label">Bounding Box</label>
        <button id="draw-bbox-btn" class="btn btn-secondary btn-sm mb-2">Draw on Map</button>
        <div class="row g-2">
            <div class="col-6"><input type="number" step="any" class="form-control" id="min-lon" placeholder="Min Lon"></div>
            <div class="col-6"><input type="number" step="any" class="form-control" id="min-lat" placeholder="Min Lat"></div>
            <div class="col-6"><input type="number" step="any" class="form-control" id="max-lon" placeholder="Max Lon"></div>
            <div class="col-6"><input type="number" step="any" class="form-control" id="max-lat" placeholder="Max Lat"></div>
        </div>
        <button id="update-bbox-btn" class="btn btn-outline-secondary btn-sm mt-2">Update from Inputs</button>
    </div>

    <hr>

    <div class="mb-3">
        <label for="routing-strategy" class="form-label">Routing Strategy</label>
        <select id="routing-strategy" class="form-select">
            <option value="fastest">Fastest (considers traffic)</option>
            <option value="shortest" selected>Shortest (network-based)</option>
        </select>
    </div>

    <div id="random-controls">
        <button id="compare-btn" class="btn btn-primary w-100 mb-3">Compare Routes</button>
    </div>
    <div id="places-controls" style="display: none;">
        <button id="compare-places-btn" class="btn btn-info w-100 mb-3">Compare POI Routes</button>
    </div>
    <div id="manual-controls" style="display: none;">
        <button id="calculate-manual-btn" class="btn btn-success w-100 mb-3" disabled>Calculate Manual Route</button>
    </div>

    <!-- Progress Bar Area -->
    <div id="progress-container" style="display: none; margin-top: 15px; margin-bottom: 15px;">
        <p id="progress-message" class="mb-1" style="font-size: 0.9em;">Starting comparison...</p>
        <div class="progress" style="height: 20px;">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
    </div>

    <div id="route-select-container" class="mb-3">
        <label for="route-select" class="form-label">Select Route Pair</label>
        <select id="route-select" class="form-select" disabled>
            <option value="all">Show All</option>
        </select>
    </div>
    
    <div id="poi-list-container" style="display: none;">
        <hr>
        <h6>Generated POIs</h6>
        <div id="poi-list" class="list-group" style="max-height: 200px; overflow-y: auto;"></div>
    </div>

    <h5>Display Options</h5>
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="google-routes-checkbox" checked><label class="form-check-label">Google Routes</label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="here-routes-checkbox" checked><label class="form-check-label">HERE Routes</label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="osm-routes-checkbox" checked><label class="form-check-label">OSM Routes</label>
    </div>
    <div class="ms-3 mt-1 mb-2">
        <label for="osm-provider-select" class="form-label" style="font-size: 0.9em;">OSM Provider</label>
        <select id="osm-provider-select" class="form-select form-select-sm">
            <option value="osrm" selected>OSRM (Free)</option>
            <option value="graphhopper">GraphHopper</option>
        </select>
    </div>
</div>

<div id="map-container">
    <button id="panel-toggle-btn" class="btn btn-light" title="Toggle Panel">
        <svg id="panel-toggle-icon" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
    </button>
    <div id="map"></div>
    <div id="coordinates-display" style="position: absolute; bottom: 10px; left: 10px; background-color: rgba(0,0,0,0.5); color: white; padding: 5px 10px; border-radius: 5px; font-family: sans-serif; font-size: 0.8em; font-style: italic; cursor: pointer; z-index: 1000;">
        Click to copy coordinates
    </div>
</div>

<div id="bottom-panel">
    <ul class="nav nav-tabs" id="bottom-panel-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-content" type="button" role="tab">Statistics</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ai-eval-tab" data-bs-toggle="tab" data-bs-target="#ai-eval-content" type="button" role="tab">AI Evaluation</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="log-tab" data-bs-toggle="tab" data-bs-target="#log-content" type="button" role="tab">Log</button>
        </li>
    </ul>
    <div class="tab-content" id="bottom-panel-content" style="height: calc(100% - 42px); overflow-y: auto; padding-top: 15px;">
        <div class="tab-pane fade show active" id="stats-content" role="tabpanel">
            <div id="stats">Click on a route to see details.</div>
            <div id="graphhopper-usage-display" class="mt-2 text-muted" style="font-size: 0.8em;"></div>
        </div>
        <div class="tab-pane fade" id="ai-eval-content" role="tabpanel">
            <div class="input-group">
                <input type="text" id="ai-prompt-input" class="form-control" placeholder="e.g., 'Which route is best for a large truck?' or 'Compare the complexity of the routes.'">
                <button class="btn btn-success" type="button" id="ai-submit-btn">Ask AI</button>
            </div>
            <div id="ai-response-area" class="mt-3 p-3 bg-light rounded" style="min-height: 100px; white-space: pre-wrap; font-family: sans-serif;">
                Select a route pair and enter a prompt to get an AI evaluation.
            </div>
        </div>
        <div class="tab-pane fade" id="log-content" role="tabpanel">
            <pre id="output-log" style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: .25rem; height: 100%; margin: 0;"></pre>
        </div>
    </div>
</div>

<div id="legend" class="p-2 bg-white rounded shadow-sm" style="position: absolute; top: 10px; right: 10px; z-index: 1000;">
    <h6 class="mb-2">Route Legend</h6>
    <div class="d-flex align-items-center mb-1">
        <span style="display: inline-block; width: 20px; height: 10px; background-color: #7627F5; margin-right: 5px;"></span>
        <span>Google Routes</span>
    </div>
    <div class="d-flex align-items-center mb-1">
        <span style="display: inline-block; width: 20px; height: 10px; background-color: #42B8B2; margin-right: 5px;"></span>
        <span>HERE Routes</span>
    </div>
    <div class="d-flex align-items-center">
        <span style="display: inline-block; width: 20px; height: 10px; background-color: #FF9A2E; margin-right: 5px;"></span>
        <span>OSM Routes</span>
    </div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.3.0/mapbox-gl-draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    mapboxgl.accessToken = '{{ mapbox_token }}';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [9.15, 48.83],
        zoom: 12
    });

    const modes = MapboxDraw.modes;
    modes.draw_rectangle = MapboxDraw.modes.draw_polygon;

    const draw = new MapboxDraw({
        displayControlsDefault: false,
        controls: {
            polygon: true, // This must be true to enable rectangle drawing mode, even if the button is hidden.
            trash: true
        },
        modes: modes,
        defaultMode: 'simple_select'
    });
    map.addControl(draw);

    // --- State and Config ---
    let BBOX = [9.10, 48.78, 9.20, 48.88]; // Default: Stuttgart
    const NUM_ROUTES = 5;
    let statsData = {};
    let manualMode = false;
    let manualOrigin = null;
    let manualDestination = null;
    let manualOriginMarker, manualDestinationMarker;

    const locations = {
        'stuttgart': {
            center: [9.15, 48.83],
            zoom: 12,
            bbox: [9.10, 48.78, 9.20, 48.88]
        },
        'dubai': {
            center: [55.3, 25.2],
            zoom: 11,
            bbox: [55.1, 25.05, 55.5, 25.35]
        },
        'bangkok': {
            center: [100.52, 13.75],
            zoom: 11,
            bbox: [100.4, 13.65, 100.7, 13.85]
        }
    };

    map.on('load', () => {
        // Add bounding box layer
        map.addSource('bbox', {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': []
                }
            }
        });
        map.addLayer({
            'id': 'bbox-layer',
            'type': 'line',
            'source': 'bbox',
            'layout': {},
            'paint': {
                'line-color': '#088',
                'line-dasharray': [2, 2]
            }
        });

        // Add sources and layers for manual route markers
        map.addSource('manual-points', {
            'type': 'geojson',
            'data': { 'type': 'FeatureCollection', 'features': [] }
        });
        map.addLayer({
            'id': 'manual-points-layer',
            'type': 'circle',
            'source': 'manual-points',
            'paint': {
                'circle-radius': 10,
                'circle-color': ['match', ['get', 'type'], 'origin', '#34A853', 'destination', '#EA4335', '#000000'],
                'circle-stroke-color': 'white',
                'circle-stroke-width': 2
            }
        });

        // --- Pre-initialize all route sources with empty data ---
        const emptyGeoJSON = { 'type': 'FeatureCollection', 'features': [] };
    const poiPointsSource = { type: 'geojson', data: emptyGeoJSON };

        map.addSource('google-routes', { type: 'geojson', data: emptyGeoJSON });
        map.addLayer({ 'id': 'google-routes-layer', 'type': 'line', 'source': 'google-routes', 'paint': { 'line-color': '#7627F5', 'line-width': 5, 'line-opacity': 0.75 } });

        map.addSource('here-routes', { type: 'geojson', data: emptyGeoJSON });
        map.addLayer({ 'id': 'here-routes-layer', 'type': 'line', 'source': 'here-routes', 'paint': { 'line-color': '#42B8B2', 'line-width': 4, 'line-opacity': 0.75 } });

    map.addSource('poi-points', poiPointsSource);

        map.addSource('osm-routes', { type: 'geojson', data: emptyGeoJSON });
        map.addLayer({ 'id': 'osm-routes-layer', 'type': 'line', 'source': 'osm-routes', 'paint': { 'line-color': '#FF9A2E', 'line-width': 3, 'line-opacity': 0.75 } });

        map.addSource('od-points', { type: 'geojson', data: emptyGeoJSON });
        map.addLayer({ id: 'od-points-layer', type: 'circle', source: 'od-points', paint: { 'circle-radius': 8, 'circle-color': ['match', ['get', 'type'], 'origin', '#00FF00', 'destination', '#FF0000', '#000000'] } });

    // Layer for POI points
    map.addLayer({
        id: 'poi-points-layer',
        type: 'symbol',
        source: 'poi-points',
        layout: {
            'icon-image': 'marker-15', // A generic marker icon
            'icon-allow-overlap': true,
            'text-field': ['get', 'label'],
            'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
            'text-offset': [0, 0.6],
            'text-anchor': 'top'
        }
    });
        // Initial draw of the BBOX after the source has been added
        updateBbox(BBOX);
        // Initial load of GH usage
        updateGraphhopperUsage();
    });

    // --- Coordinate Display ---
    const coordinatesDisplay = document.getElementById('coordinates-display');

    map.on('mousemove', (e) => {
        const lng = e.lngLat.lng.toFixed(6);
        const lat = e.lngLat.lat.toFixed(6);
        coordinatesDisplay.textContent = `Lng: ${lng}, Lat: ${lat}`;
    });

    map.on('mouseleave', () => {
        coordinatesDisplay.textContent = 'Click to copy coordinates';
    });

    map.on('contextmenu', (e) => {
        const lng = e.lngLat.lng.toFixed(6);
        const lat = e.lngLat.lat.toFixed(6);
        const coordinates = `${lng}, ${lat}`;
        copyToClipboard(coordinates, coordinatesDisplay);
    });

    coordinatesDisplay.addEventListener('click', () => {
        const text = coordinatesDisplay.textContent;
        // Avoid copying the default text
        if (text.includes('Lng:')) {
            const coordinates = text.replace('Lng: ', '').replace('Lat: ', '');
            copyToClipboard(coordinates, coordinatesDisplay);
        }
    });

    function copyToClipboard(text, element) {
        // Check if the modern Clipboard API is available
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = element.textContent;
                element.textContent = 'Copied!';
                setTimeout(() => {
                    element.textContent = originalText;
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy with modern API: ', err);
            });
        } else {
            // Fallback for non-secure contexts or older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            
            // Make the textarea invisible
            textArea.style.position = 'absolute';
            textArea.style.left = '-9999px';
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                const originalText = element.textContent;
                element.textContent = 'Copied!';
                setTimeout(() => {
                    element.textContent = originalText;
                }, 1500);
            } catch (err) {
                console.error('Fallback copy failed: ', err);
            }
            
            document.body.removeChild(textArea);
        }
    }

    // --- Event Listeners ---

    document.getElementById('country-select').addEventListener('change', (e) => {
        const selected = e.target.value;
        const location = locations[selected];
        if (location) {
            map.flyTo({
                center: location.center,
                zoom: location.zoom
            });
            updateBbox(location.bbox);
        }
    });

    document.getElementById('draw-bbox-btn').addEventListener('click', () => {
        draw.changeMode('draw_rectangle');
    });

    document.getElementById('update-bbox-btn').addEventListener('click', () => {
        const minLon = parseFloat(document.getElementById('min-lon').value);
        const minLat = parseFloat(document.getElementById('min-lat').value);
        const maxLon = parseFloat(document.getElementById('max-lon').value);
        const maxLat = parseFloat(document.getElementById('max-lat').value);
        if (!isNaN(minLon) && !isNaN(minLat) && !isNaN(maxLon) && !isNaN(maxLat)) {
            updateBbox([minLon, minLat, maxLon, maxLat]);
        } else {
            alert('Please enter valid numbers for all bounding box coordinates.');
        }
    });

    map.on('draw.create', (e) => {
        const feature = e.features[0];
        const coords = feature.geometry.coordinates[0];
        const lons = coords.map(p => p[0]);
        const lats = coords.map(p => p[1]);
        const newBbox = [Math.min(...lons), Math.min(...lats), Math.max(...lons), Math.max(...lats)];
        updateBbox(newBbox);
        // Clear the drawing and return to simple_select mode to prevent errors on redraw.
        draw.deleteAll();
        draw.changeMode('simple_select');
    });

    // --- Mode Switching ---
    document.querySelectorAll('input[name="mode-select"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const mode = this.id;
            manualMode = (mode === 'mode-manual');
            document.getElementById('random-controls').style.display = (mode === 'mode-random') ? 'block' : 'none';
            document.getElementById('manual-controls').style.display = (mode === 'mode-manual') ? 'block' : 'none';
            document.getElementById('places-controls').style.display = (mode === 'mode-places') ? 'block' : 'none';
            
            document.getElementById('route-select-container').style.display = (mode === 'mode-manual') ? 'none' : 'block';
            document.getElementById('poi-list-container').style.display = (mode === 'mode-places') ? 'block' : 'none';
            
            // Reset manual selection state when switching modes
            clearManualPoints();
            if (manualMode) {
                updateStats('manual-prompt');
            } else {
                updateStats('all'); // Revert to default stats view
            }
        });
    });

    // --- Manual Route Logic ---
    map.on('click', (e) => {
        if (!manualMode) return;

        const coords = [e.lngLat.lng, e.lngLat.lat];

        if (!manualOrigin) {
            manualOrigin = coords;
            updateManualPoints();
            updateStats('manual-dest-prompt');
        } else if (!manualDestination) {
            manualDestination = coords;
            updateManualPoints();
            document.getElementById('calculate-manual-btn').disabled = false;
            updateStats('manual-ready');
        } else {
            // If both are set, reset and start over
            clearManualPoints();
            manualOrigin = coords;
            updateManualPoints();
            updateStats('manual-dest-prompt');
        }
    });

    // --- AI Evaluation Logic ---
    document.getElementById('ai-submit-btn').addEventListener('click', () => {
        const promptInput = document.getElementById('ai-prompt-input');
        const userPrompt = promptInput.value.trim();
        const routeId = document.getElementById('route-select').value;
        const responseArea = document.getElementById('ai-response-area');
        const submitBtn = document.getElementById('ai-submit-btn');

        if (!userPrompt) {
            alert('Please enter a prompt for the AI.');
            return;
        }
        if (routeId === 'all') {
            alert('Please select a specific route pair before asking the AI.');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Thinking...';
        responseArea.textContent = ''; // Clear previous response

        fetch('/evaluate-with-ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: userPrompt, route_id: routeId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'success') {
                throw new Error(data.output);
            }
            const aiEventSource = new EventSource('/ai-stream');
            aiEventSource.onmessage = function(event) {
                const chunk = JSON.parse(event.data);
                responseArea.textContent += chunk.text;
            };
            aiEventSource.onerror = function(err) {
                aiEventSource.close();
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Ask AI';
            };
        }).catch(err => {
            responseArea.textContent = `Error: ${err.message}`;
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Ask AI';
        });
    });

    // --- Bottom Panel Toggle Logic ---
    const toggleBtn = document.getElementById('panel-toggle-btn');
    const toggleIcon = document.getElementById('panel-toggle-icon');
    const bottomPanel = document.getElementById('bottom-panel');
    const mapContainer = document.getElementById('map-container');
    const chevronUp = '<path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/>';
    const chevronDown = '<path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>';

    toggleBtn.addEventListener('click', () => {
        const isCollapsed = bottomPanel.classList.toggle('collapsed');
        if (isCollapsed) {
            mapContainer.style.bottom = '0';
            toggleIcon.innerHTML = chevronUp;
        } else {
            mapContainer.style.bottom = '300px';
            toggleIcon.innerHTML = chevronDown;
        }
        map.resize(); // Important: tell mapbox to resize to fit the new container dimensions
    });

    function triggerComparison(btn, endpoint) {
        // This function handles both Random and FSQ comparison requests.
        const routeSelect = document.getElementById('route-select');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressMessage = document.getElementById('progress-message');
        const log = document.getElementById('output-log');

        // --- Clear old map data immediately ---
        const emptyGeoJSON = { 'type': 'FeatureCollection', 'features': [] };
        map.getSource('google-routes').setData(emptyGeoJSON);
        map.getSource('here-routes').setData(emptyGeoJSON);
        map.getSource('osm-routes').setData(emptyGeoJSON);
        map.getSource('od-points').setData(emptyGeoJSON);
        map.getSource('poi-points').setData(emptyGeoJSON);
        // --- Reset and show progress bar ---
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressBar.setAttribute('aria-valuenow', '0');
        progressBar.classList.remove('bg-danger');
        progressBar.classList.add('progress-bar-animated', 'progress-bar-striped');
        progressMessage.textContent = 'Initializing...';
        btn.disabled = true;
        routeSelect.disabled = true;
        log.textContent = 'Starting route comparison...\n'; // Clear previous logs

        const strategy = document.getElementById('routing-strategy').value;
        const osmProvider = document.getElementById('osm-provider-select').value;

        // --- Start backend process ---
        fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bbox: BBOX, strategy: strategy, osm_provider: osmProvider }),
        })
            .then(response => {
                if (!response.ok) throw new Error('Failed to start comparison process.');
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    const eventSource = new EventSource('/progress');

                    eventSource.onmessage = function(event) {
                        let logData;
                        try {
                            logData = JSON.parse(event.data);
                        } catch (e) {
                            // Handle plain text if any, treat as INFO
                            logData = { level: 'INFO', message: event.data };
                        }

                        // Check if it's a progress update or a regular log message
                        if (logData.type === 'progress') {
                            progressBar.style.width = logData.progress + '%';
                            progressBar.textContent = logData.progress + '%';
                            progressBar.setAttribute('aria-valuenow', logData.progress);
                            progressMessage.textContent = logData.message;
                        } else {
                            // It's a regular log message, add it to the log window with color
                            const logEntry = document.createElement('div');
                            const level = logData.level || 'INFO';
                            const colorMap = {
                                'DEBUG': 'text-muted',
                                'INFO': 'text-dark',
                                'WARNING': 'text-warning',
                                'ERROR': 'text-danger'
                            };
                            logEntry.className = colorMap[level] || 'text-dark';
                            logEntry.textContent = `[${level}] ${logData.message}`;
                            log.appendChild(logEntry);
                            log.scrollTop = log.scrollHeight;
                        }
                    };

                    // Listen for our custom 'close' event
                    eventSource.addEventListener('close', function(event) {
                        console.log("Server signaled completion, closing connection.");
                        eventSource.close();

                        // Finalize UI and load data
                        progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                        progressMessage.textContent = 'Comparison complete! Loading results...';
                        
                        setTimeout(() => { // Give a moment for the user to see the "complete" message
                            populateRouteSelect();
                            loadRouteLayers();
                            loadPoiData(); // Load POI data for POI mode
                            loadStats();
                            updateGraphhopperUsage();
                            btn.disabled = false;
                            routeSelect.disabled = false;
                        }, 500);
                    });

                    eventSource.onerror = function(err) {
                        console.error("EventSource failed:", err);
                        progressMessage.textContent = 'An error occurred during processing.';
                        progressBar.classList.add('bg-danger');
                        eventSource.close();
                        btn.disabled = false;
                    };
                } else {
                    progressMessage.textContent = `Error: ${data.output}`;
                    progressBar.classList.add('bg-danger');
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                progressMessage.textContent = 'Failed to start the comparison process.';
                progressBar.classList.add('bg-danger');
                btn.disabled = false;
            });
    }

    // Bind the trigger function to the Random Compare button
    const randomBtn = document.getElementById('compare-btn');
    randomBtn.addEventListener('click', () => triggerComparison(randomBtn, '/compare'));
    // Bind the same logic to the Google Places button
    const placesBtn = document.getElementById('compare-places-btn');
    placesBtn.addEventListener('click', () => triggerComparison(placesBtn, '/compare-places'));

    document.getElementById('calculate-manual-btn').addEventListener('click', () => {
        if (!manualOrigin || !manualDestination) return;

        const calcBtn = document.getElementById('calculate-manual-btn');
        calcBtn.disabled = true;
        
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressMessage = document.getElementById('progress-message');
        const log = document.getElementById('output-log');

        // --- Clear old map data immediately ---
        const emptyGeoJSON = { 'type': 'FeatureCollection', 'features': [] };
        map.getSource('google-routes').setData(emptyGeoJSON);
        map.getSource('here-routes').setData(emptyGeoJSON);
        map.getSource('osm-routes').setData(emptyGeoJSON);
        map.getSource('od-points').setData(emptyGeoJSON);
        map.getSource('poi-points').setData(emptyGeoJSON);

        // --- Reset and show progress bar ---
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressBar.setAttribute('aria-valuenow', '0');
        progressBar.classList.remove('bg-danger');
        progressBar.classList.add('progress-bar-animated', 'progress-bar-striped');
        progressMessage.textContent = 'Starting manual calculation...';
        log.textContent = 'Starting manual calculation...\n';

        const strategy = document.getElementById('routing-strategy').value;
        const osmProvider = document.getElementById('osm-provider-select').value;

        fetch('/calculate-single-route', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ origin: manualOrigin, destination: manualDestination, strategy: strategy, osm_provider: osmProvider })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'success') {
                throw new Error(data.output || 'Failed to start manual calculation.');
            }

            const eventSource = new EventSource('/progress');

            eventSource.addEventListener('message', function(event) {
                let logData;
                try { 
                    logData = JSON.parse(event.data); 
                } catch (e) { 
                    console.error("Failed to parse SSE data:", e, "Raw data:", event.data);
                    return; }

                if (logData.type === 'manual_result') {
                    console.log("Received manual_result data:", logData.data); // Add this for browser console debugging
                    const result = logData.data;
                    // Directly load the returned GeoJSON data
                    map.getSource('google-routes').setData(result.google_routes);
                    map.getSource('here-routes').setData(result.here_routes);
                    map.getSource('osm-routes').setData(result.osm_routes);
                    
                    statsData = result.stats;
                    updateStats('0');

                    // Don't close the connection here. Wait for the 'close' event from the server
                    // to ensure a clean shutdown and avoid race conditions.
                }
                else if (logData.type === 'progress') {
                    // Also handle progress updates for manual mode
                    progressBar.style.width = logData.progress + '%';
                    progressBar.textContent = logData.progress + '%';
                    progressMessage.textContent = logData.message;
                }
            });

            eventSource.addEventListener('close', function(event) {
                console.log("Server signaled completion for manual route, closing connection.");
                progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                calcBtn.disabled = false;
                eventSource.close();
            });

            eventSource.addEventListener('error', function(err) {
                console.error("EventSource failed:", err);
                progressMessage.textContent = 'An error occurred during processing.';
                progressBar.classList.add('bg-danger');
                calcBtn.disabled = false;
                eventSource.close();
            });
        });
    });

    function updateBbox(newBbox) {
        BBOX = newBbox;
        
        // Update input fields
        document.getElementById('min-lon').value = BBOX[0].toFixed(6);
        document.getElementById('min-lat').value = BBOX[1].toFixed(6);
        document.getElementById('max-lon').value = BBOX[2].toFixed(6);
        document.getElementById('max-lat').value = BBOX[3].toFixed(6);

        // Update map layer
        const bboxPolygon = {
            'type': 'Feature',
            'geometry': {
                'type': 'Polygon',
                'coordinates': [[
                    [BBOX[0], BBOX[1]], [BBOX[2], BBOX[1]],
                    [BBOX[2], BBOX[3]], [BBOX[0], BBOX[3]],
                    [BBOX[0], BBOX[1]]
                ]]
            }
        };
        map.getSource('bbox').setData(bboxPolygon);
    }

    function updateGraphhopperUsage() {
        const usageDisplay = document.getElementById('graphhopper-usage-display');
        fetch('/graphhopper-usage')
            .then(response => response.json())
            .then(data => {
                usageDisplay.textContent = `GraphHopper API Calls: ${data.count} / 500`;
            })
            .catch(err => {
                console.error('Error fetching GraphHopper usage:', err);
                usageDisplay.textContent = 'Could not load GH usage.';
            });
    }

    function populateRouteSelect() {
        const select = document.getElementById('route-select');
        select.innerHTML = '<option value="all">Show All</option>';
        for (let i = 0; i < NUM_ROUTES; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Route Pair ${i + 1}`;
            select.appendChild(option);
        }
    }

    function loadStats() {
        fetch('/data/stats.json')
            .then(response => response.json())
            .then(data => {
                statsData = data;
                updateStats('all'); // Show initial stats for all
            });
    }

    function updateStats(routeId) {
        const statsDiv = document.getElementById('stats');
        if (routeId === 'all') {
            statsDiv.innerHTML = 'Select a route pair to see details.';
            return;
        }
        if (routeId === 'manual-prompt') {
            statsDiv.innerHTML = '<p class="text-info">Click on the map to set the <strong>Origin</strong> point.</p>';
            return;
        }
        if (routeId === 'manual-dest-prompt') {
            statsDiv.innerHTML = '<p class="text-info">Click on the map to set the <strong>Destination</strong> point.</p>';
            return;
        } else {
            const stats = statsData[routeId] || statsData['0']; // Handle manual mode where ID is '0'
            if (!stats) { statsDiv.innerHTML = 'No statistics available for this route.'; return; }
            const formatDistance = (meters) => meters ? `${(meters / 1000).toFixed(2)} km` : 'N/A';
            const formatDuration = (seconds) => {
                if (!seconds) return 'N/A';
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                return `${h > 0 ? h + 'h ' : ''}${m}m`;
            };

            const formatInstructions = (instructions) => {
                if (!instructions || instructions.length === 0) {
                    return '<li>No instructions available.</li>';
                }
                // Filter out empty strings and create list items
                return instructions.filter(instr => instr.trim() !== '').map(instr => `<li>${instr}</li>`).join('');
            };

            statsDiv.innerHTML = `
                <h6>Overlap with Google Route</h6>
                <p>HERE: <strong>${stats.here_coverage}</strong> | OSM: <strong>${stats.osm_coverage}</strong></p>
                <hr>
                <h6>Route Details & Instructions</h6>
                <div>
                    <p><strong>Google:</strong> ${formatDistance(stats.google_details?.distance)} / ${formatDuration(stats.google_details?.duration)}</p>
                    <ul class="list-unstyled" style="font-size: 0.9em; max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 5px; border-radius: 4px;">${formatInstructions(stats.google_details?.instructions)}</ul>
                </div>
                <div>
                    <p><strong>HERE:</strong> ${formatDistance(stats.here_details?.distance)} / ${formatDuration(stats.here_details?.duration)}</p>
                    <ul class="list-unstyled" style="font-size: 0.9em; max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 5px; border-radius: 4px;">${formatInstructions(stats.here_details?.instructions)}</ul>
                </div>
                <div>
                    <p><strong>OSM:</strong> ${formatDistance(stats.osm_details?.distance)} / ${formatDuration(stats.osm_details?.duration)}</p>
                    <ul class="list-unstyled" style="font-size: 0.9em; max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 5px; border-radius: 4px;">${formatInstructions(stats.osm_details?.instructions)}</ul>
                </div>
            `;
        }
    }

    function clearManualPoints() {
        manualOrigin = null;
        manualDestination = null;
        document.getElementById('calculate-manual-btn').disabled = true;
        updateManualPoints();
    }

    function updateManualPoints() {
        const features = [];
        if (manualOrigin) {
            features.push({
                type: 'Feature', geometry: { type: 'Point', coordinates: manualOrigin }, properties: { type: 'origin' }
            });
        }
        if (manualDestination) {
            features.push({
                type: 'Feature', geometry: { type: 'Point', coordinates: manualDestination }, properties: { type: 'destination' }
            });
        }
        map.getSource('manual-points').setData({
            type: 'FeatureCollection', features: features
        });
    }

    function loadRouteLayers() {
        console.log("Loading route layers...");
        // Add a cache-busting query parameter to ensure fresh data is loaded
        const cacheBuster = `?v=${new Date().getTime()}`;

        // Now just update the data of the pre-existing sources
        map.getSource('google-routes').setData(`/data/google_routes.geojson${cacheBuster}`);
        map.getSource('here-routes').setData(`/data/here_routes.geojson${cacheBuster}`);
        map.getSource('osm-routes').setData(`/data/osm_routes.geojson${cacheBuster}`);
        map.getSource('od-points').setData(`/data/od_points.geojson${cacheBuster}`);

        addEventListeners();
    }

    function loadPoiData() {
        const poiList = document.getElementById('poi-list');
        const poiSource = map.getSource('poi-points');
        if (!poiList || !poiSource) return;

        poiList.innerHTML = ''; // Clear previous list

        fetch(`/data/pois.json?v=${new Date().getTime()}`)
            .then(response => {
                if (!response.ok) throw new Error('pois.json not found or empty.');
                return response.json();
            })
            .then(data => {
                const poiFeatures = data.map(poi => {
                    // Create list item for the sidebar
                    const listItem = document.createElement('a');
                    listItem.className = 'list-group-item list-group-item-action';
                    listItem.innerHTML = `<strong>${poi.id}. ${poi.name}</strong><br><small class="text-muted">${poi.types.join(', ').replace(/_/g, ' ')}</small>`;
                    poiList.appendChild(listItem);

                    // Create GeoJSON feature for the map
                    return {
                        type: 'Feature',
                        geometry: { type: 'Point', coordinates: poi.coords },
                        properties: { label: String(poi.id) }
                    };
                });
                poiSource.setData({ type: 'FeatureCollection', features: poiFeatures });
            }).catch(err => console.warn("Could not load POI data:", err.message));
    }

    function addEventListeners() {
        document.getElementById('route-select').addEventListener('change', (e) => {
            const routeId = e.target.value;
            console.log("Selected route pair:", routeId);
            const filter = (routeId === 'all') ? null : ['==', 'route_id', parseInt(routeId)];
            const pointFilter = (routeId === 'all') ? null : ['==', 'pair_id', parseInt(routeId)];
            console.log("Route filter:", JSON.stringify(filter));
            console.log("Point filter:", JSON.stringify(pointFilter));
            
            map.setFilter('google-routes-layer', filter);
            map.setFilter('here-routes-layer', filter);
            map.setFilter('osm-routes-layer', filter);
            map.setFilter('od-points-layer', pointFilter);

            updateStats(routeId);
        });

        document.getElementById('google-routes-checkbox').addEventListener('change', (e) => {
            map.setLayoutProperty('google-routes-layer', 'visibility', e.target.checked ? 'visible' : 'none');
        });
        document.getElementById('here-routes-checkbox').addEventListener('change', (e) => {
            map.setLayoutProperty('here-routes-layer', 'visibility', e.target.checked ? 'visible' : 'none');
        });
        document.getElementById('osm-routes-checkbox').addEventListener('change', (e) => {
            map.setLayoutProperty('osm-routes-layer', 'visibility', e.target.checked ? 'visible' : 'none');
        });
    }
});
</script>

</body>
</html>